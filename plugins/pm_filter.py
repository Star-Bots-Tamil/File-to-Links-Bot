import asyncio
import re
import ast
import math
import random
lock = asyncio.Lock()

from pyrogram.errors.exceptions.bad_request_400 import MediaEmpty, PhotoInvalidDimensions, WebpageMediaEmpty
from Script import script
import pyrogram
from info import ADMINS, AUTH_CHANNEL, AUTH_USERS, SUPPORT_CHAT_ID, CUSTOM_FILE_CAPTION, MSG_ALRT, PICS, AUTH_GROUPS, P_TTI_SHOW_OFF, GRP_LNK, CHNL_LNK, NOR_IMG, LOG_CHANNEL, SPELL_IMG, MAX_B_TN, IMDB, \
    SINGLE_BUTTON, SPELL_CHECK_REPLY, IMDB_TEMPLATE, NO_RESULTS_MSG, IS_VERIFY, HOW_TO_VERIFY, REQ_CHANNEL, DOWNLOAD_TEXT_URL, DOWNLOAD_TEXT_NAME, LANGUAGES, SEASONS, OWNER_ID
from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery, InputMediaPhoto
from pyrogram import Client, filters, enums
from pyrogram.errors import FloodWait, UserIsBlocked, MessageNotModified, PeerIdInvalid
from utils import get_size, is_subscribed, get_poster, search_gagala, temp, get_settings, save_group_settings, get_shortlink, send_all, check_verification, get_token, get_tutorial, get_group, get_channel, get_admin, get_share
from database.database import db
import logging
logger = logging.getLogger(__name__)
logger.setLevel(logging.ERROR)

@Client.on_callback_query()
async def cb_handler(client: Client, query: CallbackQuery):
    if query.data == "close_data":
        await query.message.delete()
        await query.answer("Closed Current Process...!")
    if query.data.startswith("file"):
        clicked = query.from_user.id
        try:
            typed = query.message.reply_to_message.from_user.id
        except:
            typed = query.from_user.id
        ident, file_id = query.data.split("#")
        files_ = await get_file_details(file_id)
        if not files_:
            return await query.answer('N·¥è s·¥ú·¥Ñ ú “ì…™ ü·¥á ·¥áx…™s·¥õ.')
        files = files_[0]
        title = files.file_name
        size = get_size(files.file_size)
        f_caption = files.caption
        grp_id = await active_connection(str(query.message.from_user.id))
        settings = await get_settings(grp_id)
        FILE_CAPTION = settings["caption"]
        if settings["caption"]:
            try:
                f_caption = FILE_CAPTION.format(file_name='' if title is None else title,
                                                       file_size='' if size is None else size,
                                                       file_caption='' if f_caption is None else f_caption)
            except Exception as e:
                logger.exception(e)
            f_caption = f_caption
        if f_caption is None:
            f_caption = f"{files.file_name}"

        try:
            if (AUTH_CHANNEL or REQ_CHANNEL) and not await is_subscribed(client, query):
                if clicked == typed:
                    await query.answer(url=f"https://t.me/{temp.U_NAME}?start={ident}_{file_id}")
                    return
                else:
                    await query.answer(f"H·¥á è {query.from_user.first_name}, T ú…™s Is N·¥è·¥õ Y·¥è·¥ú Ä M·¥è·¥†…™·¥á R·¥á«´·¥ú·¥ás·¥õ. R·¥á«´·¥ú·¥ás·¥õ Y·¥è·¥ú Ä's !", show_alert=True)
            elif settings['botpm']:
                if clicked == typed:
                    await query.answer(url=f"https://t.me/{temp.U_NAME}?start={ident}_{file_id}")
                    return
                else:
                    await query.answer(f"H·¥á è {query.from_user.first_name}, T ú…™s Is N·¥è·¥õ Y·¥è·¥ú Ä M·¥è·¥†…™·¥á R·¥á«´·¥ú·¥ás·¥õ. R·¥á«´·¥ú·¥ás·¥õ Y·¥è·¥ú Ä's !", show_alert=True)
            else:
                if clicked == typed:
                    if IS_VERIFY and not await check_verification(client, query.from_user.id):
                        btn = [[
                            InlineKeyboardButton("V·¥á Ä…™“ì è", url=await get_token(client, query.from_user.id, f"https://telegram.me/{temp.U_NAME}?start=", file_id)),
                            InlineKeyboardButton("H·¥è·¥° T·¥è V·¥á Ä…™“ì è", url=HOW_TO_VERIFY)
                        ]]
                        await client.send_message(
                            chat_id=query.from_user.id,
                            text="<b>Y·¥è·¥ú ·¥Ä Ä·¥á …¥·¥è·¥õ ·¥†·¥á Ä…™“ì…™·¥á·¥Ö!\nK…™…¥·¥Ö ü è ·¥†·¥á Ä…™“ì è ·¥õ·¥è ·¥Ñ·¥è…¥·¥õ…™…¥·¥ú·¥á S·¥è ·¥õ ú·¥Ä·¥õ  è·¥è·¥ú ·¥Ñ·¥Ä…¥ …¢·¥á·¥õ ·¥Ä·¥Ñ·¥Ñ·¥áss ·¥õ·¥è ·¥ú…¥ ü…™·¥ç…™·¥õ·¥á·¥Ö ·¥ç·¥è·¥†…™·¥ás ·¥ú…¥·¥õ…™ ü 12  ú·¥è·¥ú Äs “ì Ä·¥è·¥ç …¥·¥è·¥° !</b>",
                            protect_content=True if ident == 'checksubp' else False,
                            disable_web_page_preview=True,
                            parse_mode=enums.ParseMode.HTML,
                            reply_markup=InlineKeyboardMarkup(btn)
                        )
                        return await query.answer("H·¥á è, Y·¥è·¥ú  ú·¥Ä·¥†·¥á …¥·¥è·¥õ ·¥†·¥á Ä…™“ì…™·¥á·¥Ö ·¥õ·¥è·¥Ö·¥Ä è. Y·¥è·¥ú  ú·¥Ä·¥†·¥á ·¥õ·¥è ·¥†·¥á Ä…™“ì è ·¥õ·¥è ·¥Ñ·¥è…¥·¥õ…™…¥·¥ú·¥á. C ú·¥á·¥Ñ·¥ã ·¥ç è PM ·¥õ·¥è ·¥†·¥á Ä…™“ì è ·¥Ä…¥·¥Ö …¢·¥á·¥õ “ì…™ ü·¥ás !", show_alert=True)
                    else:
                        feck=await client.send_cached_media(
                            chat_id=query.from_user.id,
                            file_id=file_id,
                            caption=f_caption+f"\n\n<b>Note :- This File Will be Deleted in {round(FILE_DELETE_TIMER/60)} Minutes. So Forward to Your Saved Messages.</b>",
                            protect_content=True if ident == "filep" else False,
                            reply_markup=InlineKeyboardMarkup(
                                [
                                [
                                InlineKeyboardButton('S·¥ú·¥ò·¥ò·¥è Ä·¥õ G Ä·¥è·¥ú·¥ò', url=await get_group(grp_id)),
                                InlineKeyboardButton('U·¥ò·¥Ö·¥Ä·¥õ·¥ás C ú·¥Ä…¥…¥·¥á ü', url=await get_channel(grp_id))
                            ],[
                                InlineKeyboardButton("B·¥è·¥õ O·¥°…¥·¥á Ä", url=await get_admin(grp_id))
                                ]
                                ]
                            )
                        )
                        return await query.answer('C ú·¥á·¥Ñ·¥ã PM, I  ú·¥Ä·¥†·¥á s·¥á…¥·¥õ “ì…™ ü·¥ás …™…¥ PM', show_alert=True)
                else:
                    return await query.answer(f"H·¥á è {query.from_user.first_name}, T ú…™s Is N·¥è·¥õ Y·¥è·¥ú Ä M·¥è·¥†…™·¥á R·¥á«´·¥ú·¥ás·¥õ. R·¥á«´·¥ú·¥ás·¥õ Y·¥è·¥ú Ä's !", show_alert=True)
        except UserIsBlocked:
            await query.answer('U…¥ ô ü·¥è·¥Ñ·¥ã ·¥õ ú·¥á  ô·¥è·¥õ ·¥ç·¥Ä ú…¥ !', show_alert=True)
        except PeerIdInvalid:
            await query.answer(url=f"https://t.me/{temp.U_NAME}?start={ident}_{file_id}")
        except Exception as e:
            await query.answer(url=f"https://t.me/{temp.U_NAME}?start={ident}_{file_id}")
            await asyncio.sleep(FILE_DELETE_TIMER)
            await feck.delete()
    elif query.data.startswith("checksub"):
        if (AUTH_CHANNEL or REQ_CHANNEL) and not await is_subscribed(client, query):
            await query.answer("J·¥è…™…¥ ·¥è·¥ú Ä B·¥Ä·¥Ñ·¥ã-·¥ú·¥ò ·¥Ñ ú·¥Ä…¥…¥·¥á ü ·¥ç·¥Ä ú…¥! üòí", show_alert=True)
            return
        ident, file_id = query.data.split("#")
        if file_id == "send_all":
            send_files = temp.SEND_ALL_TEMP.get(query.from_user.id)
            is_over = await send_all(client, query.from_user.id, send_files, ident)
            if is_over == 'done':
                return await query.answer(f"H·¥á è {query.from_user.first_name}, A ü ü “ì…™ ü·¥ás ·¥è…¥ ·¥õ ú…™s ·¥ò·¥Ä…¢·¥á  ú·¥Äs  ô·¥á·¥á…¥ s·¥á…¥·¥õ s·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è ·¥õ·¥è  è·¥è·¥ú Ä PM !", show_alert=True)
            elif is_over == 'fsub':
                return await query.answer("H·¥á è, Y·¥è·¥ú ·¥Ä Ä·¥á …¥·¥è·¥õ ·¥ä·¥è…™…¥·¥á·¥Ö …™…¥ ·¥ç è  ô·¥Ä·¥Ñ·¥ã ·¥ú·¥ò ·¥Ñ ú·¥Ä…¥…¥·¥á ü. C ú·¥á·¥Ñ·¥ã ·¥ç è PM ·¥õ·¥è ·¥ä·¥è…™…¥ ·¥Ä…¥·¥Ö …¢·¥á·¥õ “ì…™ ü·¥ás !", show_alert=True)
            elif is_over == 'verify':
                return await query.answer("H·¥á è, Y·¥è·¥ú  ú·¥Ä·¥†·¥á …¥·¥è·¥õ ·¥†·¥á Ä…™“ì…™·¥á·¥Ö ·¥õ·¥è·¥Ö·¥Ä è. Y·¥è·¥ú  ú·¥Ä·¥†·¥á ·¥õ·¥è ·¥†·¥á Ä…™“ì è ·¥õ·¥è ·¥Ñ·¥è…¥·¥õ…™…¥·¥ú·¥á. C ú·¥á·¥Ñ·¥ã ·¥ç è PM ·¥õ·¥è ·¥†·¥á Ä…™“ì è ·¥Ä…¥·¥Ö …¢·¥á·¥õ “ì…™ ü·¥ás !", show_alert=True)
            else:
                return await query.answer(f"E Ä Ä·¥è Ä: {is_over}", show_alert=True)
        files_ = await get_file_details(file_id)
        if not files_:
            return await query.answer('N·¥è s·¥ú·¥Ñ ú “ì…™ ü·¥á ·¥áx…™s·¥õ.')
        files = files_[0]
        title = files.file_name
        size = get_size(files.file_size)
        grp_id = await active_connection(str(message.from_user.id))
        settings = await get_settings(grp_id)
        FILE_CAPTION = settings["caption"]
        f_caption = files.caption
        if settings["caption"]:
            try:
                f_caption = FILE_CAPTION.format(file_name='' if title is None else title,
                                                       file_size='' if size is None else size,
                                                       file_caption='' if f_caption is None else f_caption)
            except Exception as e:
                logger.exception(e)
                f_caption = f_caption
        if f_caption is None:
            f_caption = f"{title}"
        await query.answer()
        if IS_VERIFY and not await check_verification(client, query.from_user.id):
            btn = [[
                InlineKeyboardButton("V·¥á Ä…™“ì è", url=await get_token(client, query.from_user.id, f"https://telegram.me/{temp.U_NAME}?start=", file_id)),
                InlineKeyboardButton("H·¥è·¥° T·¥è V·¥á Ä…™“ì è", url=HOW_TO_VERIFY)
            ]]
            await client.send_message(
                chat_id=query.from_user.id,
                text="<b>Y·¥è·¥ú ·¥Ä Ä·¥á …¥·¥è·¥õ ·¥†·¥á Ä…™“ì…™·¥á·¥Ö!\nK…™…¥·¥Ö ü è ·¥†·¥á Ä…™“ì è ·¥õ·¥è ·¥Ñ·¥è…¥·¥õ…™…¥·¥ú·¥á S·¥è ·¥õ ú·¥Ä·¥õ  è·¥è·¥ú ·¥Ñ·¥Ä…¥ …¢·¥á·¥õ ·¥Ä·¥Ñ·¥Ñ·¥áss ·¥õ·¥è ·¥ú…¥ ü…™·¥ç…™·¥õ·¥á·¥Ö ·¥ç·¥è·¥†…™·¥ás ·¥ú…¥·¥õ…™ ü 12  ú·¥è·¥ú Äs “ì Ä·¥è·¥ç …¥·¥è·¥° !</b>",
                protect_content=True if ident == 'checksubp' else False,
                disable_web_page_preview=True,
                parse_mode=enums.ParseMode.HTML,
                reply_markup=InlineKeyboardMarkup(btn)
            )
            return
        feck=await client.send_cached_media(
            chat_id=query.from_user.id,
            file_id=file_id,
            caption=f_caption+f"\n\n<b>Note :- This File Will be Deleted in {round(FILE_DELETE_TIMER/60)} Minutes. So Forward to Your Saved Messages.</b>",
            protect_content=True if ident == 'checksubp' else False,
            reply_markup=InlineKeyboardMarkup(
                [
                 [
                  InlineKeyboardButton('S·¥ú·¥ò·¥ò·¥è Ä·¥õ G Ä·¥è·¥ú·¥ò', url=await get_group(grp_id)),
                  InlineKeyboardButton('U·¥ò·¥Ö·¥Ä·¥õ·¥ás C ú·¥Ä…¥…¥·¥á ü', url=await get_channel(grp_id))
               ],[
                  InlineKeyboardButton("B·¥è·¥õ O·¥°…¥·¥á Ä", url=await get_admin(grp_id))
                 ]
                ]
            )
        )
        await asyncio.sleep(FILE_DELETE_TIMER)
        await feck.delete()

    elif query.data == "start":
        buttons = [[
                    InlineKeyboardButton('‚§¨ A·¥Ö·¥Ö M·¥á T·¥è Y·¥è·¥ú Ä G Ä·¥è·¥ú·¥ò ‚§¨', url=f'http://t.me/{temp.U_NAME}?startgroup=true')
                ],[
                    InlineKeyboardButton('‚ôö B·¥è·¥õ O·¥°…¥·¥á Ä', callback_data="owner_info"),
                    InlineKeyboardButton('‚å¨ S·¥ú·¥ò·¥ò·¥è Ä·¥õ G Ä·¥è·¥ú·¥ò', url=GRP_LNK)
                ],[
                    InlineKeyboardButton('„ÄÑ H·¥á ü·¥ò', callback_data='help'),
                    InlineKeyboardButton('‚çü A ô·¥è·¥ú·¥õ', callback_data='about'),
                    InlineKeyboardButton('I…¥ ü…™…¥·¥á S·¥á·¥Ä Ä·¥Ñ ú ‚òå', switch_inline_query_current_chat='')
                ],[
                    InlineKeyboardButton('‚úá J·¥è…™…¥ U·¥ò·¥Ö·¥Ä·¥õ·¥ás C ú·¥Ä…¥…¥·¥á ü ‚úá', url=CHNL_LNK)
                  ]]
        
        reply_markup = InlineKeyboardMarkup(buttons)
        await client.edit_message_media(
            query.message.chat.id, 
            query.message.id, 
            InputMediaPhoto(random.choice(PICS))
        )
        await query.message.edit_text(
            text=script.START_TXT.format(query.from_user.mention, temp.U_NAME, temp.B_NAME),
            reply_markup=reply_markup,
            parse_mode=enums.ParseMode.HTML
        )
        await query.answer(MSG_ALRT)
    
    elif query.data == "help":
        buttons = [[
            InlineKeyboardButton('üìä Status', callback_data='stats'),            
            ],[
            InlineKeyboardButton('Custom to Your Bot ü§ñ', callback_data='stats'),            
            ],[
            InlineKeyboardButton('Filters', callback_data='filters'),
            InlineKeyboardButton('Group Manage', callback_data='group_manege'),
            InlineKeyboardButton('Connections', callback_data='coct')
            ],[                       
            InlineKeyboardButton('IMDB', callback_data='template'),
            InlineKeyboardButton('Your Info', callback_data='extra'),
            InlineKeyboardButton('Json', callback_data='son')
            ],[           
            InlineKeyboardButton('Font', callback_data='font'),
            InlineKeyboardButton('Share Text', callback_data='sharetxt'),           
            InlineKeyboardButton('Text 2 Speech', callback_data='ttss')
            ],[
            InlineKeyboardButton('Graph', callback_data='graph'),
            InlineKeyboardButton("File Store", callback_data='newdata'),
            InlineKeyboardButton('Sticker ID', callback_data='stickerid')                                   
            ],[                               
            InlineKeyboardButton('Purge', callback_data='purges'),
            InlineKeyboardButton('Ping', callback_data='pings'),
            InlineKeyboardButton('Short Link', callback_data='short')
            ],[
            InlineKeyboardButton('Password', callback_data='password'),
            InlineKeyboardButton("Paste", callback_data='pastes'),
            InlineKeyboardButton('YT-DL', callback_data='ytdl')
            ],[
            InlineKeyboardButton('Country Info', callback_data='country'),
            InlineKeyboardButton('Translate', callback_data='translate'),
            InlineKeyboardButton('File Store', callback_data='store_file')
            ],[
            InlineKeyboardButton('üè† Home üè†', callback_data='start')           
        ]]
        reply_markup = InlineKeyboardMarkup(buttons)
        await query.edit_message_media(
            query.message.chat.id, 
            query.message.id, 
            InputMediaPhoto(random.choice(PICS), script.HELP_TXT.format(query.from_user.mention), enums.ParseMode.HTML),
            reply_markup=reply_markup
            #parse_mode=enums.ParseMode.HTML
        )
    
    elif query.data == "stats":
        buttons = [[
            InlineKeyboardButton('‚ü∏ B·¥Ä·¥Ñ·¥ã', callback_data='help'),
            InlineKeyboardButton('‚ü≤ R·¥á“ì Ä·¥ás ú', callback_data='rfrsh')
        ]]
        await client.edit_message_media(
            query.message.chat.id, 
            query.message.id, 
            InputMediaPhoto(random.choice(PICS))
        )
        reply_markup = InlineKeyboardMarkup(buttons)
        users = await db.total_users_count()
        monsize = await db.get_db_size()
        free = 536870912 - monsize
        monsize = get_size(monsize)
        free = get_size(free)
        if query.from_user.id in ADMINS:
            await query.message.edit_text(script.STATUS_TXT.format(users, monsize, free), enums.ParseMode.HTML), reply_markup=reply_markup)
        else:
            await query.answer("Your Not Administrator ‚ö†Ô∏è", show_alert=True)

    elif query.data == "rfrsh":
        await query.answer("Fetching MongoDb DataBase")
        buttons = [[
            InlineKeyboardButton('‚ü∏ B·¥Ä·¥Ñ·¥ã', callback_data='help'),
            InlineKeyboardButton('‚ü≤ R·¥á“ì Ä·¥ás ú', callback_data='rfrsh')
        ]]
        await client.edit_message_media(
            query.message.chat.id, 
            query.message.id, 
            InputMediaPhoto(random.choice(PICS))
        )
        reply_markup = InlineKeyboardMarkup(buttons)
        users = await db.total_users_count()
        monsize = await db.get_db_size()
        free = 536870912 - monsize
        monsize = get_size(monsize)
        free = get_size(free)
        if query.from_user.id in ADMINS:
            await query.message.edit_text(script.STATUS_TXT.format(users, monsize, free), enums.ParseMode.HTML), reply_markup=reply_markup)
        else:
            await query.answer("Your Not Administrator ‚ö†Ô∏è", show_alert=True)
    elif query.data == "refresh":
        await query.answer("Fetching MongoDb DataBase")
        buttons = [[
            InlineKeyboardButton('üåÄ Refresh', callback_data='refresh')
        ]]
        reply_markup = InlineKeyboardMarkup(buttons)
        users = await db.total_users_count()
        monsize = await db.get_db_size()
        free = 536870912 - monsize
        monsize = get_size(monsize)
        free = get_size(free)
        if query.from_user.id in ADMINS:
            await query.message.edit_text(script.STATUS_TXT.format(users, monsize, free), enums.ParseMode.HTML), reply_markup=reply_markup)
        else:
            await query.answer("Your Not Administrator ‚ö†Ô∏è", show_alert=True)
